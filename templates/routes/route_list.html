{% extends "base.html" %}
{% block title %}Routes{% endblock %}
{% block content %}
  <div class="page-title">
    <h1>Routes</h1>
  </div>

  <div class="stack">
    {% for r in routes %}
      <div class="card">
        <!-- Row 1: title · by user · time -->
        <div class="row" style="justify-content: space-between; align-items: baseline;">
          <a class="job-title" href="{% url 'routes:detail' r.pk %}" style="font-weight:700; text-decoration:none;">
            {{ r.title }}
          </a>
          <small class="muted">by {{ r.author.username }} · {{ r.created_at|date:"Y-m-d H:i" }}</small>
        </div>

        <!-- Row 2: difficulty -->
        <div style="margin-top:6px;">
          <span class="badge">Difficulty: {{ r.difficulty }}</span>
        </div>

        <!-- Row 3: description -->
        {% if r.description %}
          <div style="margin-top:10px;">
            <p>Description: {{ r.description|linebreaksbr }}</p>
          </div>
        {% endif %}

        <!-- Row 4: map -->
        {% with r.map_embed_src as map_src %}
          {% if map_src %}
            <div style="margin-top:12px; border-radius:10px; overflow:hidden;">
              <iframe
                width="600" height="300" style="width:100%; border:0;"
                loading="lazy" allowfullscreen
                referrerpolicy="no-referrer-when-downgrade"
                src="{{ map_src }}">
              </iframe>
            </div>
          {% elif r.location_name %}
            <p class="muted" style="margin-top:6px;">Location: {{ r.location_name }}</p>
          {% endif %}
        {% endwith %}

        <!-- Row 5: images (3 per row, up to 9), square & centered; click to zoom -->
        {% if r.images.all or r.picture %}
          <div class="routes-grid" style="margin-top:12px;">
            {% for img in r.images.all|slice:":9" %}
              <button class="img-cell" data-lightbox="{{ img.image.url }}" data-caption="{{ img.alt_text|default:r.title }}" title="Click to zoom" style="border:0; padding:0; background:none; cursor:pointer;">
                <img src="{{ img.image.url }}" alt="{{ img.alt_text|default:r.title }}">
              </button>
            {% endfor %}
            {% if r.picture %}
              <button class="img-cell" data-lightbox="{{ r.picture.url }}" data-caption="{{ r.title }}" title="Click to zoom" style="border:0; padding:0; background:none; cursor:pointer;">
                <img src="{{ r.picture.url }}" alt="{{ r.title }}">
              </button>
            {% endif %}
          </div>
        {% endif %}

        <!-- Row 6: embedded video (YouTube) -->
        {% with r.youtube_embed_src as embed %}
          {% if embed %}
            <div style="margin-top:12px;">
              <iframe
                src="{{ embed }}"
                title="YouTube video player"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                referrerpolicy="strict-origin-when-cross-origin"
                allowfullscreen
                style="max-width:100%; width:100%; aspect-ratio:16/9; border-radius:10px;"></iframe>
            </div>
          {% elif r.video_url %}
            <p style="margin-top:10px;">
              <a href="{{ r.video_url }}" target="_blank" rel="noopener">Watch on YouTube</a>
            </p>
          {% endif %}
        {% endwith %}
      </div>
    {% empty %}
      <div class="card"><p class="muted">No routes yet.</p></div>
    {% endfor %}
  </div>

  <!-- Lightbox root (single shared modal for the page) -->
  <div class="lightbox" id="lightbox" aria-hidden="true">
    <button class="close-btn" id="lightbox-close" aria-label="Close">✕</button>
    <div class="lightbox-body" style="text-align:center;">
      <img id="lightbox-img" alt="">
      <div class="caption" id="lightbox-caption"></div>
    </div>
  </div>

  <script>
    (function() {
      const lb = document.getElementById('lightbox');
      const imgTag = document.getElementById('lightbox-img');
      const caption = document.getElementById('lightbox-caption');
      const closeBtn = document.getElementById('lightbox-close');

      function openLightbox(src, cap) {
        imgTag.src = src;
        imgTag.alt = cap || '';
        caption.textContent = cap || '';
        lb.classList.add('is-open');
        lb.setAttribute('aria-hidden', 'false');
      }
      function closeLightbox() {
        lb.classList.remove('is-open');
        lb.setAttribute('aria-hidden', 'true');
        imgTag.src = '';
        caption.textContent = '';
      }

      document.addEventListener('click', function(e) {
        const target = e.target.closest('[data-lightbox]');
        if (target) {
          e.preventDefault();
          openLightbox(target.getAttribute('data-lightbox'), target.getAttribute('data-caption'));
        }
      });
      closeBtn.addEventListener('click', closeLightbox);
      lb.addEventListener('click', function(e) { if (e.target === lb) closeLightbox(); });
      document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeLightbox(); });
    })();
  </script>
{% endblock %}
