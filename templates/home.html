{% extends "base.html" %}
{% block title %}Climbr - Discover Routes{% endblock %}

{% block content %}
<div class="map-container">
  <div id="map" class="climbing-map"></div>
  
  <!-- Floating search bar -->
  <div class="search-overlay">
    <div class="search-bar">
      <input type="text" id="search-input" placeholder="Search locations (e.g. Yosemite, Boulder, etc.)" />
      <button id="search-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
      </button>
      <div id="search-results" class="search-results hidden"></div>
    </div>
  </div>

  <!-- Route details popup -->
  <div id="route-popup" class="route-popup hidden">
    <div class="route-popup-content">
      <button id="close-popup" class="close-btn">&times;</button>
      <div id="popup-body"></div>
    </div>
  </div>

  <!-- Floating action button for adding routes -->
  {% if user.is_authenticated %}
  <div class="fab-container">
    <a href="{% url 'routes:add' %}" class="fab">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    </a>
  </div>
  {% endif %}
</div>

<style>
.map-container {
  position: relative;
  width: 100vw;
  height: 100vh;
  margin-left: calc(-50vw + 50%);
  margin-right: calc(-50vw + 50%);
  margin-top: -2rem;
  margin-bottom: -2rem;
}

.climbing-map {
  width: 100%;
  height: 100%;
  z-index: 1;
}

.search-overlay {
  position: absolute;
  top: 120px;
  left: 20px;
  right: 20px;
  z-index: 1000;
  display: flex;
  justify-content: center;
}

.search-bar {
  position: relative;
  display: flex;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 25px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  overflow: visible;
  width: 100%;
  max-width: 500px;
}

.search-results {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(15px);
  border-radius: 15px;
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
  margin-top: 5px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1001;
}

.search-result-item {
  padding: 12px 20px;
  cursor: pointer;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  transition: background-color 0.2s;
}

.search-result-item:hover {
  background: rgba(37, 99, 235, 0.1);
}

.search-result-item:last-child {
  border-bottom: none;
}

.search-result-main {
  font-weight: 500;
  color: #111827;
  font-size: 14px;
}

.search-result-subtitle {
  font-size: 12px;
  color: #6b7280;
  margin-top: 2px;
}

.popular-suggestion {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(245, 158, 11, 0.02));
  border-left: 3px solid rgba(245, 158, 11, 0.3);
}

.popular-suggestion:hover {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
}

.search-bar input {
  flex: 1;
  border: none;
  padding: 12px 20px;
  font-size: 16px;
  background: transparent;
  outline: none;
}

.search-bar button {
  border: none;
  background: transparent;
  padding: 12px 15px;
  cursor: pointer;
  color: #666;
  transition: color 0.2s;
}

.search-bar button:hover {
  color: #333;
}

.route-popup {
  position: absolute;
  bottom: 20px;
  left: 20px;
  right: 20px;
  z-index: 1000;
  background: white;
  border-radius: 20px;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
  max-height: 60vh;
  overflow-y: auto;
  transform: translateY(100%);
  transition: transform 0.3s ease-out;
}

.route-popup:not(.hidden) {
  transform: translateY(0);
}

.route-popup-content {
  position: relative;
  padding: 20px;
}

.close-btn {
  position: absolute;
  top: 15px;
  right: 20px;
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #666;
  padding: 5px;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-btn:hover {
  background: #f0f0f0;
}

.fab-container {
  position: absolute;
  bottom: 30px;
  right: 30px;
  z-index: 1000;
}

.fab {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 56px;
  height: 56px;
  background: #2563eb;
  color: white;
  border-radius: 50%;
  box-shadow: 0 4px 20px rgba(37, 99, 235, 0.3);
  text-decoration: none;
  transition: all 0.3s ease;
}

.fab:hover {
  background: #1d4ed8;
  transform: scale(1.1);
  box-shadow: 0 6px 25px rgba(37, 99, 235, 0.4);
}

.route-marker {
  background: #2563eb;
  border: 3px solid white;
  border-radius: 50%;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

.user-location-marker {
  background: transparent !important;
  border: none !important;
}

.user-location-dot {
  position: relative;
  width: 20px;
  height: 20px;
}

.user-location-center {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 8px;
  height: 8px;
  background: #1e40af;
  border: 2px solid white;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  z-index: 2;
}

.user-location-pulse {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  background: rgba(30, 64, 175, 0.3);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    transform: translate(-50%, -50%) scale(0.5);
    opacity: 1;
  }
  100% {
    transform: translate(-50%, -50%) scale(2);
    opacity: 0;
  }
}

.route-info {
  text-align: left;
}

.route-title {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 8px;
  color: #333;
}

.route-meta {
  display: flex;
  gap: 15px;
  margin-bottom: 10px;
  font-size: 14px;
  color: #666;
}

.route-difficulty {
  background: #f3f4f6;
  padding: 4px 8px;
  border-radius: 12px;
  font-weight: 500;
}

.route-description {
  color: #555;
  line-height: 1.5;
  margin-bottom: 15px;
}

.route-actions {
  display: flex;
  gap: 10px;
}

.btn-view {
  background: #2563eb;
  color: white;
  text-decoration: none;
  padding: 8px 16px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 500;
  transition: background 0.2s;
}

.btn-view:hover {
  background: #1d4ed8;
  text-decoration: none;
  color: white;
}

.hidden {
  display: none;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
  .search-overlay {
    left: 10px;
    right: 10px;
    top: 110px;
  }
  
  .search-bar {
    max-width: none;
  }
  
  .search-bar input {
    padding: 10px 16px;
    font-size: 15px;
  }
  
  .route-popup {
    left: 10px;
    right: 10px;
    bottom: 10px;
  }
  
  .fab-container {
    bottom: 20px;
    right: 20px;
  }
}

@media (max-width: 480px) {
  .search-overlay {
    top: 105px;
  }
}
</style>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

<script>
// User location data from Django
const userLocation = {% if user_location %}{{ user_location|safe }}{% else %}null{% endif %};

// Initialize the map
let initialView = [39.7392, -104.9903]; // Default: Colorado
let initialZoom = 6;

// If user has location, center on it
if (userLocation) {
  initialView = [userLocation.latitude, userLocation.longitude];
  initialZoom = 10; // Closer zoom for user's area
}

const map = L.map('map', {
  zoomControl: false,
  attributionControl: false
}).setView(initialView, initialZoom);

// Add zoom control to top right
L.control.zoom({
  position: 'topright'
}).addTo(map);

// Add tile layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);

// Routes data from Django
const routes = [
  {% for route in routes %}
  {
    id: {{ route.pk }},
    title: "{{ route.title|escapejs }}",
    description: "{{ route.description|truncatechars:150|escapejs }}",
    difficulty: {{ route.difficulty }},
    author: "{{ route.author.username|escapejs }}",
    location: "{{ route.location_name|escapejs }}",
    lat: {{ route.latitude }},
    lng: {{ route.longitude }},
    detailUrl: "{% url 'routes:detail' route.pk %}"
  }{% if not forloop.last %},{% endif %}
  {% endfor %}
];

// Custom marker icon
const createMarkerIcon = (difficulty) => {
  const color = difficulty <= 3 ? '#10b981' : difficulty <= 6 ? '#f59e0b' : '#ef4444';
  return L.divIcon({
    className: 'route-marker',
    html: `<div style="background: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold;">${difficulty}</div>`,
    iconSize: [24, 24],
    iconAnchor: [12, 12]
  });
};

// Add markers to map
const markers = [];
routes.forEach(route => {
  const marker = L.marker([route.lat, route.lng], {
    icon: createMarkerIcon(route.difficulty)
  }).addTo(map);
  
  marker.routeData = route;
  markers.push(marker);
  
  // Click handler for markers
  marker.on('click', function() {
    showRoutePopup(route);
  });
});

// Add user location marker if available
let userMarker = null;
if (userLocation) {
  // Create a pulsing circle for user location (like Google Maps)
  const userLocationIcon = L.divIcon({
    className: 'user-location-marker',
    html: `
      <div class="user-location-dot">
        <div class="user-location-pulse"></div>
        <div class="user-location-center"></div>
      </div>
    `,
    iconSize: [20, 20],
    iconAnchor: [10, 10]
  });
  
  userMarker = L.marker([userLocation.latitude, userLocation.longitude], {
    icon: userLocationIcon,
    zIndexOffset: 1000 // Keep user marker on top
  }).addTo(map);
  
  // Add tooltip for user location
  userMarker.bindTooltip('Your location', {
    permanent: false,
    direction: 'top',
    offset: [0, -10]
  });
}

// Fit map to show all markers if any exist, otherwise use user location or default
if (routes.length > 0) {
  const allMarkers = [...markers];
  if (userMarker) {
    allMarkers.push(userMarker);
  }
  const group = new L.featureGroup(allMarkers);
  map.fitBounds(group.getBounds().pad(0.1));
} else if (userLocation) {
  // No routes, but user has location - already centered on user location
} else {
  // No routes, no user location - use default view (already set)
}

// Show route popup
function showRoutePopup(route) {
  const popup = document.getElementById('route-popup');
  const popupBody = document.getElementById('popup-body');
  
  popupBody.innerHTML = `
    <div class="route-info">
      <div class="route-title">${route.title}</div>
      <div class="route-meta">
        <span class="route-difficulty">V${route.difficulty}</span>
        <span>by ${route.author}</span>
        ${route.location ? `<span>üìç ${route.location}</span>` : ''}
      </div>
      <div class="route-description">${route.description}</div>
      <div class="route-actions">
        <a href="${route.detailUrl}" class="btn-view">View Details</a>
      </div>
    </div>
  `;
  
  popup.classList.remove('hidden');
}

// Close popup
document.getElementById('close-popup').addEventListener('click', function() {
  document.getElementById('route-popup').classList.add('hidden');
});

// Search functionality with geocoding
const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');
const searchResults = document.getElementById('search-results');

let searchTimeout;

// Popular climbing destinations for quick suggestions
const popularClimbingAreas = [
  { name: 'Yosemite Valley, CA', lat: 37.7749, lng: -119.4194 },
  { name: 'Joshua Tree, CA', lat: 33.8734, lng: -116.4069 },
  { name: 'Red River Gorge, KY', lat: 37.7779, lng: -83.6646 },
  { name: 'Boulder, CO', lat: 40.0150, lng: -105.2705 },
  { name: 'Moab, UT', lat: 38.5733, lng: -109.5498 },
  { name: 'Eldorado Canyon, CO', lat: 39.9317, lng: -105.2927 },
  { name: 'New River Gorge, WV', lat: 37.9773, lng: -81.0784 },
  { name: 'Smith Rock, OR', lat: 44.3672, lng: -121.1403 }
];

// Show popular suggestions for short queries
function showPopularSuggestions(query) {
  const filteredAreas = popularClimbingAreas.filter(area => 
    area.name.toLowerCase().includes(query.toLowerCase())
  );
  
  if (filteredAreas.length > 0) {
    searchResults.innerHTML = '';
    
    filteredAreas.forEach(area => {
      const item = document.createElement('div');
      item.className = 'search-result-item popular-suggestion';
      item.innerHTML = `
        <div class="search-result-main">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 6px; color: #f59e0b;">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
          ${area.name}
        </div>
        <div class="search-result-subtitle">Popular climbing area</div>
      `;
      
      item.addEventListener('click', () => {
        searchInput.value = area.name;
        hideSearchResults();
        map.setView([area.lat, area.lng], 12);
      });
      
      searchResults.appendChild(item);
    });
    
    searchResults.classList.remove('hidden');
    return true;
  }
  return false;
}

// Debounced search function
function debounceSearch() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    const query = searchInput.value.trim();
    if (query.length === 0) {
      hideSearchResults();
    } else if (query.length <= 2) {
      // Show popular suggestions for short queries
      if (!showPopularSuggestions(query)) {
        hideSearchResults();
      }
    } else {
      performGeocodingSearch(query);
    }
  }, 300);
}

// City abbreviations and aliases mapping
const cityAliases = {
  'la': 'Los Angeles, CA',
  'nyc': 'New York City, NY',
  'sf': 'San Francisco, CA',
  'dc': 'Washington, DC',
  'chi': 'Chicago, IL',
  'philly': 'Philadelphia, PA',
  'vegas': 'Las Vegas, NV',
  'nola': 'New Orleans, LA',
  'atl': 'Atlanta, GA',
  'pdx': 'Portland, OR',
  'sac': 'Sacramento, CA',
  'sd': 'San Diego, CA',
  'mia': 'Miami, FL',
  'det': 'Detroit, MI',
  'sj': 'San Jose, CA',
  'oak': 'Oakland, CA',
  'sea': 'Seattle, WA',
  'den': 'Denver, CO',
  'phx': 'Phoenix, AZ',
  'dal': 'Dallas, TX',
  'hou': 'Houston, TX',
  'sa': 'San Antonio, TX',
  'aus': 'Austin, TX',
  'indy': 'Indianapolis, IN',
  'nash': 'Nashville, TN',
  'mem': 'Memphis, TN',
  'noc': 'North Conway, NH',
  'reno': 'Reno, NV',
  'tahoe': 'Lake Tahoe, CA',
  'moab': 'Moab, UT',
  'jtree': 'Joshua Tree, CA',
  'yose': 'Yosemite, CA',
  'rrg': 'Red River Gorge, KY',
  'eldorado': 'Eldorado Canyon, CO',
  'eldo': 'Eldorado Canyon, CO',
  'flatirons': 'Boulder, CO',
  'gunks': 'New Paltz, NY',
  'seneca': 'Seneca Rocks, WV'
};

// Expand query with aliases and variations
function expandQuery(query) {
  const lowerQuery = query.toLowerCase().trim();
  
  // Check for exact alias match
  if (cityAliases[lowerQuery]) {
    return cityAliases[lowerQuery];
  }
  
  // Check for partial matches in aliases
  for (const [alias, fullName] of Object.entries(cityAliases)) {
    if (alias.includes(lowerQuery) || lowerQuery.includes(alias)) {
      return fullName;
    }
  }
  
  return query;
}

// Perform geocoding search using Nominatim (OpenStreetMap)
async function performGeocodingSearch(query) {
  try {
    const expandedQuery = expandQuery(query);
    const searches = [];
    
    // Primary search with expanded query
    searches.push(
      fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=3&q=${encodeURIComponent(expandedQuery)}&countrycodes=us&addressdetails=1`)
    );
    
    // If original query was expanded, also search original
    if (expandedQuery !== query) {
      searches.push(
        fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=2&q=${encodeURIComponent(query)}&countrycodes=us&addressdetails=1`)
      );
    }
    
    // Add a more specific search for climbing areas
    searches.push(
      fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=2&q=${encodeURIComponent(query + ' climbing')}&countrycodes=us&addressdetails=1`)
    );
    
    const responses = await Promise.all(searches);
    const allResults = [];
    
    for (const response of responses) {
      const results = await response.json();
      allResults.push(...results);
    }
    
    // Remove duplicates based on display_name
    const uniqueResults = allResults.filter((result, index, self) => 
      index === self.findIndex(r => r.display_name === result.display_name)
    );
    
    // Sort by relevance (exact matches first, then by importance)
    const sortedResults = uniqueResults.sort((a, b) => {
      const aName = a.display_name.toLowerCase();
      const bName = b.display_name.toLowerCase();
      const queryLower = query.toLowerCase();
      
      // Exact city name matches first
      const aExact = aName.includes(queryLower);
      const bExact = bName.includes(queryLower);
      
      if (aExact && !bExact) return -1;
      if (!aExact && bExact) return 1;
      
      // Then by importance score
      const aImportance = parseFloat(a.importance || 0);
      const bImportance = parseFloat(b.importance || 0);
      return bImportance - aImportance;
    });
    
    if (sortedResults.length > 0) {
      showSearchResults(sortedResults.slice(0, 5)); // Show top 5
    } else {
      hideSearchResults();
    }
  } catch (error) {
    console.error('Geocoding error:', error);
    hideSearchResults();
  }
}

// Show search results dropdown
function showSearchResults(results) {
  searchResults.innerHTML = '';
  
  results.forEach(result => {
    const item = document.createElement('div');
    item.className = 'search-result-item';
    
    // Better formatting for different location types
    let displayName, subtitle;
    
    if (result.address) {
      const addr = result.address;
      const city = addr.city || addr.town || addr.village;
      const state = addr.state;
      const county = addr.county;
      
      if (city && state) {
        displayName = `${city}, ${state}`;
        if (county && county !== city) {
          subtitle = county;
        }
      } else if (county && state) {
        displayName = `${county}, ${state}`;
      } else {
        displayName = result.display_name.split(',').slice(0, 3).join(', ');
      }
    } else {
      displayName = result.display_name.split(',').slice(0, 3).join(', ');
    }
    
    // Create the item HTML
    item.innerHTML = `
      <div class="search-result-main">${displayName}</div>
      ${subtitle ? `<div class="search-result-subtitle">${subtitle}</div>` : ''}
    `;
    
    item.addEventListener('click', () => {
      selectLocation(result, displayName);
    });
    
    searchResults.appendChild(item);
  });
  
  searchResults.classList.remove('hidden');
}

// Hide search results dropdown
function hideSearchResults() {
  searchResults.classList.add('hidden');
}

// Select a location from search results
function selectLocation(result, displayName) {
  const lat = parseFloat(result.lat);
  const lng = parseFloat(result.lon);
  
  // Update search input
  searchInput.value = displayName;
  hideSearchResults();
  
  // Center map on selected location
  map.setView([lat, lng], 12);
  
  // Store in localStorage
  localStorage.setItem('climbr-last-search', JSON.stringify({
    name: displayName,
    lat: lat,
    lng: lng
  }));
}

// Manual search button click
function performSearch() {
  const query = searchInput.value.trim();
  if (query) {
    performGeocodingSearch(query);
  }
}

// Event listeners
searchInput.addEventListener('input', debounceSearch);
searchInput.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    performSearch();
  }
});
searchBtn.addEventListener('click', performSearch);

// Hide results when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('.search-bar')) {
    hideSearchResults();
  }
});

// Close popup when clicking on map
map.on('click', function() {
  document.getElementById('route-popup').classList.add('hidden');
});
</script>
{% endblock %}
