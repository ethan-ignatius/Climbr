{% extends "base.html" %}
{% block title %}Climbr - Discover Routes{% endblock %}

{% block content %}
<div class="map-container">
  <div id="map" class="climbing-map"></div>
  
  <!-- Floating search bar -->
  <div class="search-overlay">
    <div class="search-bar">
      <input type="text" id="search-input" placeholder="Search routes, locations..." />
      <button id="search-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Route details popup -->
  <div id="route-popup" class="route-popup hidden">
    <div class="route-popup-content">
      <button id="close-popup" class="close-btn">&times;</button>
      <div id="popup-body"></div>
    </div>
  </div>

  <!-- Floating action button for adding routes -->
  {% if user.is_authenticated %}
  <div class="fab-container">
    <a href="{% url 'routes:add' %}" class="fab">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    </a>
  </div>
  {% endif %}
</div>

<style>
.map-container {
  position: relative;
  width: 100vw;
  height: 100vh;
  margin-left: calc(-50vw + 50%);
  margin-right: calc(-50vw + 50%);
  margin-top: -2rem;
  margin-bottom: -2rem;
}

.climbing-map {
  width: 100%;
  height: 100%;
  z-index: 1;
}

.search-overlay {
  position: absolute;
  top: 20px;
  left: 20px;
  right: 20px;
  z-index: 1000;
  display: flex;
  justify-content: center;
}

.search-bar {
  display: flex;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 25px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  overflow: hidden;
  min-width: 300px;
  max-width: 500px;
  width: 100%;
}

.search-bar input {
  flex: 1;
  border: none;
  padding: 12px 20px;
  font-size: 16px;
  background: transparent;
  outline: none;
}

.search-bar button {
  border: none;
  background: transparent;
  padding: 12px 15px;
  cursor: pointer;
  color: #666;
  transition: color 0.2s;
}

.search-bar button:hover {
  color: #333;
}

.route-popup {
  position: absolute;
  bottom: 20px;
  left: 20px;
  right: 20px;
  z-index: 1000;
  background: white;
  border-radius: 20px;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
  max-height: 60vh;
  overflow-y: auto;
  transform: translateY(100%);
  transition: transform 0.3s ease-out;
}

.route-popup:not(.hidden) {
  transform: translateY(0);
}

.route-popup-content {
  position: relative;
  padding: 20px;
}

.close-btn {
  position: absolute;
  top: 15px;
  right: 20px;
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #666;
  padding: 5px;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-btn:hover {
  background: #f0f0f0;
}

.fab-container {
  position: absolute;
  bottom: 30px;
  right: 30px;
  z-index: 1000;
}

.fab {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 56px;
  height: 56px;
  background: #2563eb;
  color: white;
  border-radius: 50%;
  box-shadow: 0 4px 20px rgba(37, 99, 235, 0.3);
  text-decoration: none;
  transition: all 0.3s ease;
}

.fab:hover {
  background: #1d4ed8;
  transform: scale(1.1);
  box-shadow: 0 6px 25px rgba(37, 99, 235, 0.4);
}

.route-marker {
  background: #2563eb;
  border: 3px solid white;
  border-radius: 50%;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

.route-info {
  text-align: left;
}

.route-title {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 8px;
  color: #333;
}

.route-meta {
  display: flex;
  gap: 15px;
  margin-bottom: 10px;
  font-size: 14px;
  color: #666;
}

.route-difficulty {
  background: #f3f4f6;
  padding: 4px 8px;
  border-radius: 12px;
  font-weight: 500;
}

.route-description {
  color: #555;
  line-height: 1.5;
  margin-bottom: 15px;
}

.route-actions {
  display: flex;
  gap: 10px;
}

.btn-view {
  background: #2563eb;
  color: white;
  text-decoration: none;
  padding: 8px 16px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 500;
  transition: background 0.2s;
}

.btn-view:hover {
  background: #1d4ed8;
  text-decoration: none;
  color: white;
}

.hidden {
  display: none;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
  .search-overlay {
    left: 10px;
    right: 10px;
  }
  
  .route-popup {
    left: 10px;
    right: 10px;
    bottom: 10px;
  }
  
  .fab-container {
    bottom: 20px;
    right: 20px;
  }
}
</style>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

<script>
// Initialize the map
const map = L.map('map', {
  zoomControl: false,
  attributionControl: false
}).setView([39.7392, -104.9903], 6); // Center on Colorado

// Add zoom control to top right
L.control.zoom({
  position: 'topright'
}).addTo(map);

// Add tile layer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);

// Routes data from Django
const routes = [
  {% for route in routes %}
  {
    id: {{ route.pk }},
    title: "{{ route.title|escapejs }}",
    description: "{{ route.description|truncatechars:150|escapejs }}",
    difficulty: {{ route.difficulty }},
    author: "{{ route.author.username|escapejs }}",
    location: "{{ route.location_name|escapejs }}",
    lat: {{ route.latitude }},
    lng: {{ route.longitude }},
    detailUrl: "{% url 'routes:detail' route.pk %}"
  }{% if not forloop.last %},{% endif %}
  {% endfor %}
];

// Custom marker icon
const createMarkerIcon = (difficulty) => {
  const color = difficulty <= 3 ? '#10b981' : difficulty <= 6 ? '#f59e0b' : '#ef4444';
  return L.divIcon({
    className: 'route-marker',
    html: `<div style="background: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold;">${difficulty}</div>`,
    iconSize: [24, 24],
    iconAnchor: [12, 12]
  });
};

// Add markers to map
const markers = [];
routes.forEach(route => {
  const marker = L.marker([route.lat, route.lng], {
    icon: createMarkerIcon(route.difficulty)
  }).addTo(map);
  
  marker.routeData = route;
  markers.push(marker);
  
  // Click handler for markers
  marker.on('click', function() {
    showRoutePopup(route);
  });
});

// Fit map to show all markers if any exist
if (routes.length > 0) {
  const group = new L.featureGroup(markers);
  map.fitBounds(group.getBounds().pad(0.1));
}

// Show route popup
function showRoutePopup(route) {
  const popup = document.getElementById('route-popup');
  const popupBody = document.getElementById('popup-body');
  
  popupBody.innerHTML = `
    <div class="route-info">
      <div class="route-title">${route.title}</div>
      <div class="route-meta">
        <span class="route-difficulty">V${route.difficulty}</span>
        <span>by ${route.author}</span>
        ${route.location ? `<span>üìç ${route.location}</span>` : ''}
      </div>
      <div class="route-description">${route.description}</div>
      <div class="route-actions">
        <a href="${route.detailUrl}" class="btn-view">View Details</a>
      </div>
    </div>
  `;
  
  popup.classList.remove('hidden');
}

// Close popup
document.getElementById('close-popup').addEventListener('click', function() {
  document.getElementById('route-popup').classList.add('hidden');
});

// Search functionality
const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');

function performSearch() {
  const query = searchInput.value.toLowerCase().trim();
  if (!query) return;
  
  // Find matching routes
  const matchingRoutes = routes.filter(route => 
    route.title.toLowerCase().includes(query) ||
    route.location.toLowerCase().includes(query) ||
    route.author.toLowerCase().includes(query)
  );
  
  if (matchingRoutes.length > 0) {
    // Show first match in popup
    showRoutePopup(matchingRoutes[0]);
    
    // Center map on the route
    map.setView([matchingRoutes[0].lat, matchingRoutes[0].lng], 14);
  }
}

searchBtn.addEventListener('click', performSearch);
searchInput.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    performSearch();
  }
});

// Close popup when clicking on map
map.on('click', function() {
  document.getElementById('route-popup').classList.add('hidden');
});
</script>
{% endblock %}
